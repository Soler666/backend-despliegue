// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                Int      @id @default(autoincrement())
  username          String   @unique
  role              String   @default("ALUMNO") // ALUMNO, TUTOR o ADMIN
  firstName         String?
  lastName          String?
  email             String?  @unique
  profileComplete   Boolean  @default(false)
  status            String   @default("PENDING") // PENDING, APPROVED, REJECTED
  password          String
  googleId          String?  @unique
  googleAccessToken String?
  googleRefreshToken String?
  googleTokenExpiry  DateTime?
  calendarId        String?
  projects          Project[] @relation("ProjectParticipants")
  tasks             Task[]    @relation("UserTasks")
  tutorProjects     Project[] @relation("ProjectTutor")
  tutoredTasks      Task[]    @relation("TutorTasks")
  chatMessages      ChatMessage[] @relation("ChatUser")
  receivedMessages  ChatMessage[] @relation("MessageRecipient")
  notifications     Notification[] @relation("UserNotifications")
  reminders         Reminder[] @relation("UserReminders")
  studentSubmissions Submission[] @relation("StudentSubmissions")
  tutorGradings     Submission[] @relation("TutorGradings")
  activityLogs      ActivityLog[] @relation("UserActivityLogs")
  createdExams      Exam[] @relation("ExamCreator")
  examSubmissions   ExamSubmission[] @relation("ExamStudent")
  chatbotConversations ChatbotConversation[] @relation("UserChatbotConversations")
}

model Project {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  startDate    DateTime?
  endDate      DateTime?
  status       String   // Planificaci√≥n, En progreso, Completado, Pausado
  googleEventId String?
  tasks        Task[]
  participants User[] @relation("ProjectParticipants")
  tutor        User?    @relation("ProjectTutor", fields: [tutorId], references: [id])
  tutorId      Int?
}

model Task {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  dueDate      DateTime?
  priority     String   // Baja, Media, Alta
  status       String   // Pendiente, En progreso, Completada, Bloqueada
  type         String   @default("project")  // "daily" o "project"
  googleEventId String?
  project      Project? @relation(fields: [projectId], references: [id])
  projectId    Int?
  responsible  User     @relation("UserTasks", fields: [responsibleId], references: [id])
  responsibleId Int
  tutor        User?    @relation("TutorTasks", fields: [tutorId], references: [id])
  tutorId      Int?
  submissions  Submission[]
}

model ChatMessage {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation("ChatUser", fields: [userId], references: [id])
  message     String
  timestamp   DateTime @default(now())
  recipientId Int?
  recipient   User?    @relation("MessageRecipient", fields: [recipientId], references: [id])
  isPrivate   Boolean  @default(false)
}

model Notification {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation("UserNotifications", fields: [userId], references: [id])
  message      String
  type         String
  isRead       Boolean  @default(false)
  createdAt    DateTime @default(now())
  relatedId    Int?
  relatedType  String?
}

model Reminder {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation("UserReminders", fields: [userId], references: [id])
  title        String
  description  String?
  scheduledAt  DateTime
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  relatedId    Int?
  relatedType  String?
}

model File {
  id           Int      @id @default(autoincrement())
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  uploadedAt   DateTime @default(now())
  submission   Submission? @relation(fields: [submissionId], references: [id])
  submissionId Int?
}

model Submission {
  id           Int      @id @default(autoincrement())
  taskId       Int
  task         Task     @relation(fields: [taskId], references: [id])
  studentId    Int
  student      User     @relation("StudentSubmissions", fields: [studentId], references: [id])
  submittedAt  DateTime @default(now())
  content      String?
  grade        Float?
  feedback     String?
  gradedAt     DateTime?
  gradedBy     Int?
  gradedByUser User?   @relation("TutorGradings", fields: [gradedBy], references: [id])
  status       String   @default("submitted")
  files        File[]
}

model ActivityLog {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation("UserActivityLogs", fields: [userId], references: [id])
  action       String
  entityType   String
  entityId     Int
  details      String?
  oldValues    String?
  newValues    String?
  timestamp    DateTime @default(now())
}

model ChatbotConversation {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation("UserChatbotConversations", fields: [userId], references: [id])
  title        String?
  messages     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Exam {
  id               Int             @id @default(autoincrement())
  title            String
  topics           String
  numQuestions     Int
  timeLimit        Int
  generatedQuestions String
  createdBy        Int
  createdByUser    User            @relation("ExamCreator", fields: [createdBy], references: [id])
  assignedTo       String
  status           String          @default("active")
  createdAt        DateTime        @default(now())
  submissions      ExamSubmission[]
  questions        ExamQuestion[]
}

model ExamQuestion {
  id            Int     @id @default(autoincrement())
  examId        Int
  exam          Exam    @relation(fields: [examId], references: [id])
  question      String
  options       String?
  correctAnswer String
  type          String
}

model ExamSubmission {
  id         Int      @id @default(autoincrement())
  examId     Int
  exam       Exam     @relation(fields: [examId], references: [id])
  studentId  Int
  student    User     @relation("ExamStudent", fields: [studentId], references: [id])
  answers    String
  score      Float
  submittedAt DateTime @default(now())
  review     String?
}